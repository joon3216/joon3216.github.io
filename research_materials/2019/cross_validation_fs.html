<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Junkyu Park" />


<title>Cross-validation for fusion estimates</title>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-139050237-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-139050237-1');
</script>
<!-- A new navigation bar style settings -->
<style type="text/css">
/* at the top */
#navbar
{
    position: sticky;
    z-index: 1000; /* new; why: make navbar closest to the observer */
    top: 0;
    left: 0;
    padding: 0; /* old: 10px 25px */
    background: rgba(28, 44, 56, 0.99);
    width: 100%;
    height: 50px;
    box-sizing: border-box;
    border-bottom: 1px solid #EAEAEB;
    transition: .5s;
}
#navbar .logo
{
    float: left;
}
#navbar .logo img
{
    height: 30px;
    /* new: margin; why: so that in header, padding can be 0 */
    /* note: header nav ul li a has margin 20px on left and right, 
    so here I let the right margin of img to be 5px so that it matches
    with the left margin 25px */
    /* edit: 5 to 20px since it looks nicer */
    margin: 10px 20px 10px 25px; 
}
#navbar nav
{
    float: right; /* old: left; why change: to give a more standard look */
    margin: 0 27.5px 0 0;
}
#navbar nav ul
{
    margin: 0;
    padding: 0;
    display: flex;

}
#navbar nav ul li
{
    padding: 0;
    list-style: none;
    position: relative;
    /* new: margin and padding; why: header padding is now 0 */
    margin: 0;
    padding: 8.5px 0 8.5px 0;
}
/* new; why: texts with arrow on the right gets more space  */
#navbar nav ul li.sub-menu
{
    /* why 8.5px: that's the value in header nav ul li padding */
    padding: 8.5px 27.5px 8.5px 0;
    padding-bottom: 12px;
    /* new; why: to make dropdown menu available once the mouse is on the menu item that it belongs, and to not affect other menu items that is not of class sub-menu */
}

/* new; why: prepare in case of text-align: right */
#navbar nav ul li#news
{
    padding: 8.5px 0;
    margin: 0;
}

/* new; why: this potentially has a different background color */
#navbar nav ul li#home
{
    background-color: rgba(21, 92, 148, .9); /* old: rgba(28, 44, 56, 0); */
    border-bottom: 1px solid #EAEAEB;
    margin: 0 0 .5px 0;
}

#navbar nav ul li.sub-menu:before
{
    content: '\f0d7'; /* &#9660 ▼ nabla */
    font-family: fontAwesome; /* old: sans-serif */
    font-size: 16pt;
    position: absolute;
    /*line-height: 30px;*/
    color: #ffffff;
    top: 7pt;
    right: 22.5px;
    cursor: pointer;
}
#navbar nav ul li.active.sub-menu:before
{
    content: '\f0d8';  /* &#9650 ▲ Delta */
    font-family: fontAwesome; /* new */
    font-size: 16pt;
    position: absolute;
    color: #666;
    top: 7pt;
    right: 22.5px;
    cursor: pointer;
}
#navbar nav ul li ul
{
    position: absolute;
    left: 0;
    top: 50px; /* controls the box position of dropdown menus */
    background: rgba(57, 143, 209, 0.99);
    display: none;
}
#navbar nav ul li.active ul
{
    display: block;
}

/* new; why: make dropdown menu box fit to the menu above */
/* padding: 0; is for slimmer individual dropdown menu items */
/* old */
#navbar nav ul li.sub-menu ul li
{
    display: block;
    width: 200px;
    padding: 5px 0;
}

/* new: header nav ul li ul li a */
/* why: giving an indentation */
#navbar nav ul li ul li a
{
    margin: 0 40px;
}

/* header nav ul li#projects.sub-menu ul li
{
    display: block;
    width: 115px;
    padding: 0;
}
header nav ul li#rm.sub-menu ul li
{
    display: block;
    width: 197px;
    padding: 0;
} */

#navbar nav ul li a
{
    height: 30px;
    line-height: 30px;
    padding: 0; /* old: 0 20px, and margin didn't exist; why change: to make text the only clickable object */
    margin: 0 20px;
    color: #ffffff;
    text-decoration: none;
    text-shadow: none; /* new; why: to be compatible with the Tactile theme */
    /*display: block;*/
}

/* new: news; why add: to make News go to the right */
/* commented out because the same effect is achieved by having 
header nav ul li.sub-menu padding: 8.5px 15px 8.5px 0; */
/* header nav ul li.news
{
    margin: 0 0 0 20px;
} */

/* new: rm; why: to make r_m go to the right */
/* commented out because the same effect is achieved by having 
header nav ul li.sub-menu padding: 8.5px 15px 8.5px 0; */
/* header nav ul li#rm
{
    margin: 0 0 0 20px;
} */


#navbar nav ul li a:hover
{
    color: #666;
}

/* new: header nav ul li:hover ul, why: to make dropdown menu appear whenever mouse is above */
#navbar nav ul li:hover ul
{
    display: block;
}

#navbar nav ul li:hover ul li:hover
{
    background-color: rgba(5, 83, 143, 0.99);
}

.menu-toggle
{
    color: #ffffff;
    float: right;
    line-height: 30px;
    font-size: 24px;
    cursor: pointer;
    display: none;
    text-shadow: none;
}
@media (max-width: 800px) /* old1: 991px; old2: 721px */
{
    /* at the top */
    #navbar
    {
        padding: 0; /* old: 10px 25px */
    }
    .menu-toggle
    {
        display: block;
        margin: 10px 25px /* new; why: header padding is now 0 */
    }
    #navbar nav
    {
        /*display: none;*/
        overflow: auto; /* new; why: when mobile, make sure scroll shows up if vertical space not sufficient to display every element of nav */
        position: absolute;
        width: 100%;
        height: calc(100vh - 50px);
        background: rgba(28, 44, 56, 0.99);
        top: 50px;
        left: -100%;
        transition: .5s;
    }
    #navbar nav.active
    {
        left: 0;
    }
    #navbar nav ul
    {
        display: block;
        /*text-align: center;*/
    }

    /* new; why: to make sure it doesn't appear in mobile view;
    I don't want to see it in mobile since the logo already directs you
    to home. Adding home in mobile seems a clutter.
    */
    #navbar nav ul li#home
    {
        display: none;
    }

    #navbar nav ul li a
    {
        border-bottom: 1px solid rgba(255, 255, 255, .5);
        height: 50px;
        line-height: 50px;
        padding: 0 20px;
    }
    #navbar nav ul li.active ul
    {
        position: relative;
    }
    #navbar nav ul li ul li
    {
        width: 100%;
    }

    /* new: header nav ul li.sub-menu */
    /* why: so that dropdown menus fill the entire row in mobile */
    #navbar nav ul li.sub-menu
    {
        padding: 8.5px 0;
    }

    #navbar nav ul li.sub-menu:before
    {
        content: '+'; /* old: &#9660 nabla */
        font-size: 20pt;
        font-family: sans-serif;
        height: 40px;
        position: absolute;
        /* line-height: 30px; */
        color: #ffffff;
        width: 20px;
        /* top: 5pt; */
        right: 25px;
        cursor: pointer;
        bottom: 18px;
    }
    #navbar nav ul li.active.sub-menu:before
    {
        content: '–';  /* new: &#9650 Delta */
        font-size: 20pt;
        /* top: 5pt; */
        right: 25px;
        /* line-height: 30px; */
        cursor: pointer;
        position: absolute;
        color: #666;
        bottom: 18px;
        height: 40px;
    }
    #navbar nav ul li ul
    {
        position: absolute;
        left: 0;
        top: 0px; /* controls the box position of 2018 and 2019 under Research materials */
        background: rgba(57, 143, 209, 0.99);
        display: none;
    }

    /* new: hover and active
    why: do not display drop down menus when mouse is over it in mobile, 
    but display them when plus signs are clicked */
    #navbar nav ul li:hover ul
    {
        display: none;
    }
    #navbar nav ul li.active ul
    {
        display: block;
    }

    /* new; why: no background color change in dropdown menu when hovering over in mobile */
    #navbar nav ul li.sub-menu:hover ul li:hover
    {
        background-color: rgba(5, 83, 143, 0);
    }

    /* new: News; why: to make News align with the others in mobile */
    /* commented out since Research Materials uses different method
    to get more space on its right (header nav ul li.sub-menu padding) */

    /* header nav ul li.news
    {
        margin: 0;
    } */
    /* new: rm; why: to make rm align with the others in mobile */
    /* commented out for the same reason */
    /* header nav ul li#rm
    {
        margin: 0;
    } */

    /* while scrolling */
    #navbar.black nav ul li a:hover
    {
        color: #666;
    }
}

/* while scrolling */
#navbar.black
{
    background: rgba(21, 92, 148, .9);
}
#navbar.black nav ul li#home
{
    background-color: rgba(28, 44, 56, 0);
    /* border-bottom: 1px solid #EAEAEB;
    margin: 0 0 .5px 0; why commented: unnecessary */
    transition: .2s;
}
#navbar.black nav ul li a:hover
{
    color: darkgrey;
}
#navbar.black nav ul li.active.sub-menu:before
{
    color: darkgrey;
}
</style>

<!-- 1. Navigation bar color change as one scrolls -->
<!-- by adding a new class="black" while scrolling -->
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript">
    $(window).on('scroll', function(){
        if ($(window).scrollTop()){
           navbar.classList.add('black');
           /* old: $('header').addClass('black'); */
        }
        else
        {
            navbar.classList.remove('black');
            /* old: $('header').removeClass('black'); */
        }
    })
</script>

<!-- 2. Navigation bar slides from the left in mobile -->
<!-- 3. Only one dropdown menu at a time will appear -->
<script type="text/javascript">
    $(document).ready(function(){
        $('.menu-toggle').click(function(){
            $('nav').toggleClass('active')
        })
        $('ul li').click(function(){
            $(this).siblings().removeClass('active');
            $(this).toggleClass('active');
        })
    })
</script>

<!-- Using caret down and up symbols -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
<link rel="icon" href="../../style/all_orange_jp.png">


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link rel="stylesheet" href="cross_validation_fs_files/style.css" type="text/css" />

</head>

<body>


<!-- A new navigation bar -->
<div id="navbar">
    <div class="logo">
        <a href="../../index.html"><img src="../../style/all_orange_jp.png"></a>
    </div>
    <nav>
        <ul>
            <li id="home">
                <a href="../../index.html">Home</a>
            </li>
            <li class="sub-menu" id="projects">
                <a href="../../projects.html">Projects</a>
                <ul>
                    <li>
                        <a href="../../projects/2019.html">2019</a>
                    </li>
                </ul>
            </li>
            <li class="sub-menu" id="rm">
                <a href="../../research_materials.html">Research materials</a>
                <ul>
                    <li>
                        <a href="../../research_materials/2018.html">2018</a>
                    </li>
                    <li>
                        <a href="../../research_materials/2019.html">2019</a>
                    </li>
                </ul>
            </li>
            <li id="news">
                <a href="../../news.html">News</a>
            </li>
            <li>
                <a href="../../files/resume_junkyu_park.pdf">Resume</a>
            </li>
        </ul>
    </nav>
    <div class="menu-toggle">
        <i class="fa fa-bars" aria-hidden="true"></i>
    </div>
</div>


<section class="page-header">
<h1 class="title toc-ignore project-name">Cross-validation for fusion estimates</h1>
<h4 class="author project-author">Junkyu Park</h4>
</section>



<section class="main-content">
<p>The following external R packages/functions are used:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)
gather &lt;-<span class="st"> </span>tidyr<span class="op">::</span>gather</code></pre></div>
<p>This note is a continuation from <a href="../2018/non_separable_penalty.html">Dealing with a non-separable penalty term</a> under <a href="../2018.html">2018</a>: Statistical Computation.</p>

<div id="TOC" class="toc" style="padding:2rem 2rem 0 0;">
<ul style="list-style:none;">
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#choosing-a-tuning-parameter">2. Choosing a tuning parameter</a></li>
<li><a href="#an-example">3. An example</a></li>
<li><a href="#session-info">Session info</a></li>
<li><a href="#related-page">Related page</a></li>
</ul>
</div>
&nbsp;

<div id="introduction" class="section level1">
<h1>1. Introduction</h1>
<p>This note concerns with a cross-validation method. In particular, it is interested in finding an optimal tuning parameter <span class="math inline">\(\lambda\)</span> and a corresponding <span class="math inline">\(\boldsymbol{\theta}\)</span> that yields a lowest cross-validation error. The note will demonstrate how the cross-validation is used to find <span class="math inline">\(\lambda\)</span>, and provide functions that help achieve the goal.</p>
</div>
<div id="choosing-a-tuning-parameter" class="section level1">
<h1>2. Choosing a tuning parameter</h1>
<p>From the <a href="../2018/non_separable_penalty.html">previous note</a>, I assumed: <span class="math display">\[y_t = \theta_t + \varepsilon_t\]</span> with <span class="math inline">\(\varepsilon_t \stackrel{iid}{\sim} N(0, \sigma^2)\)</span>, and used the cost function that has a penalty: <span class="math display">\[\text{cost}(\theta_1, \phi_2, \dots, \phi_n) = \sum_{t = 1}^{n} (y_t - \theta_t)^2 + \lambda \sum_{t = 2}^{n} |\phi_t|\]</span> where <span class="math inline">\(\phi_t = \theta_t - \theta_{t - 1}\)</span>.</p>
<p>To find an optimal <span class="math inline">\(\lambda\)</span>, we shall use the following strategy:</p>
<ol style="list-style-type: decimal">
<li>Divide <span class="math inline">\(y_t\)</span>’s into <span class="math inline">\(k\)</span> folds where the <span class="math inline">\(s\)</span><sup>th</sup> fold is defined as <span class="math inline">\(\text{Fold}_s := \{ y_{t} \}_{t \in A_s}\)</span>, where <span class="math inline">\(A_s = \{t \leq n \text{ | } t = s + kt^*, t^* \geq 0 \}\)</span>.</li>
<li>Given <span class="math inline">\(\lambda\)</span>, compute the estimates <span class="math inline">\(\boldsymbol{\theta}_s\)</span>’s based on <span class="math inline">\(\{y_t \}_{t \notin \text{Fold}_s}\)</span> for all <span class="math inline">\(s = 1, \dots, k\)</span>.</li>
<li>Define <span class="math inline">\(\text{interpolate}_{\boldsymbol{\theta}_s}(t)\)</span> for each <span class="math inline">\(s\)</span>, an interpolating function based on <span class="math inline">\(\boldsymbol{\theta}_s\)</span>.</li>
<li>Compute <span class="math inline">\(\text{loss}_s\)</span> for each <span class="math inline">\(s\)</span> where <span class="math display">\[\text{loss}_s := \frac{1}{|\text{Fold}_s|} \sum_{t \in \text{Fold}_s} (\text{interpolate}_{\boldsymbol{\theta}_s}(t) - y_t)^2\]</span></li>
<li>Compute <span class="math inline">\(\text{error} := \frac{1}{k}\sum_{s = 1}^{k} \text{loss}_s\)</span>.</li>
<li>Choose <span class="math inline">\(\lambda\)</span> that yields a minimum <span class="math inline">\(\text{error}\)</span>.</li>
</ol>
<p>Step 1 is performed by <code>split_data_1d</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">split_data_1d &lt;-<span class="st"> </span><span class="cf">function</span>(y, num_folds, fold) {
    <span class="co"># y: a numeric vector</span>
    <span class="co"># num_folds: a natural number &lt;= number of observations, e.g. 5</span>
    <span class="co"># fold: a natural number &lt;= num_folds, e.g. 3</span>
    
    n &lt;-<span class="st"> </span><span class="kw">length</span>(y)
    indices &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>n
    assign_folds &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>num_folds, n <span class="op">%/%</span><span class="st"> </span>num_folds <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)[indices]
    partition &lt;-<span class="st"> </span><span class="kw">split</span>(indices, assign_folds)
    fold_indices &lt;-<span class="st"> </span>partition[[fold]]
    y_fold &lt;-<span class="st"> </span>y[fold_indices]
    y_rest &lt;-<span class="st"> </span>y[<span class="op">-</span>fold_indices]
    <span class="kw">list</span>(
        <span class="dt">y_fold =</span> <span class="kw">list</span>(
            <span class="dt">data =</span> y_fold,
            <span class="dt">indices =</span> fold_indices
        ), 
        <span class="dt">y_rest =</span> <span class="kw">list</span>(
            <span class="dt">data =</span> y_rest, 
            <span class="dt">indices =</span> (<span class="dv">1</span><span class="op">:</span>n)[<span class="op">!</span>(<span class="dv">1</span><span class="op">:</span>n <span class="op">%in%</span><span class="st"> </span>fold_indices)]
        )
    )
}</code></pre></div>
<p>Step 2 is performed by <code>fusion_estimates</code>, a function defined in the <a href="../2018/non_separable_penalty.html">previous note</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fusion_estimates &lt;-<span class="st"> </span><span class="cf">function</span>(y, theta, lambda, <span class="dt">max_iter =</span> <span class="dv">1000</span>, <span class="dt">eps =</span> <span class="fl">1e-5</span>) {
    n &lt;-<span class="st"> </span><span class="kw">length</span>(y)
    <span class="cf">if</span> (<span class="kw">missing</span>(theta)) {theta &lt;-<span class="st"> </span>y}
    <span class="cf">if</span> (<span class="kw">length</span>(theta) <span class="op">!=</span><span class="st"> </span>n) {
        <span class="kw">stop</span>(<span class="kw">paste0</span>(
            <span class="st">&#39;</span><span class="ch">\n</span><span class="st">Error in fusion_estimates():</span><span class="ch">\n</span><span class="st">&#39;</span>, 
            <span class="st">&#39;The length of given initial theta is &#39;</span>, <span class="kw">length</span>(theta),
            <span class="st">&#39;, which is not equal to length(y) == &#39;</span>, n, <span class="st">&#39;.&#39;</span>
        ))
    }
    phi &lt;-<span class="st"> </span><span class="kw">diff</span>(theta)
    phisums_old &lt;-<span class="st"> </span><span class="kw">cumsum</span>(phi)
    theta_1_new &lt;-<span class="st"> </span>(<span class="kw">sum</span>(y) <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(phisums_old)) <span class="op">/</span><span class="st"> </span>n
    cost &lt;-<span class="st"> </span><span class="kw">sum</span>((y <span class="op">-</span><span class="st"> </span>theta)<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>lambda <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">abs</span>(phi))
    costs &lt;-<span class="st"> </span><span class="ot">NULL</span>
    costs[<span class="dv">1</span>] &lt;-<span class="st"> </span>cost <span class="co"># costs</span>
    there_is_a_progress &lt;-<span class="st"> </span>T
    iter &lt;-<span class="st"> </span><span class="dv">0</span>
    <span class="cf">while</span> (there_is_a_progress <span class="op">&amp;</span><span class="st"> </span>iter <span class="op">&lt;</span><span class="st"> </span>max_iter) {
        <span class="co"># Store new phi_1 (= 0) to phi_n in phi_new</span>
        phi_new &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="dt">length =</span> n) 
        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>n) {
            phisums_new &lt;-<span class="st"> </span><span class="kw">cumsum</span>(phi_new)
            req &lt;-<span class="st"> </span><span class="kw">sum</span>(
                phisums_old[(j <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span>(n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)] <span class="op">-</span><span class="st"> </span>
<span class="st">                </span>phisums_old[j <span class="op">-</span><span class="st"> </span><span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>phisums_new[j <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]
            )
            discri &lt;-<span class="st"> </span><span class="kw">sum</span>(y[j<span class="op">:</span>n]) <span class="op">-</span><span class="st"> </span>(n <span class="op">-</span><span class="st"> </span>j <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>theta_1_new <span class="op">-</span><span class="st"> </span>req
            <span class="cf">if</span> (discri <span class="op">&lt;</span><span class="st"> </span><span class="op">-</span>lambda <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) {
                phi_new[j] &lt;-<span class="st"> </span>(discri <span class="op">+</span><span class="st"> </span>lambda <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(n <span class="op">-</span><span class="st"> </span>j <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)
            } <span class="cf">else</span> <span class="cf">if</span> (discri <span class="op">&gt;</span><span class="st"> </span>lambda <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) {
                phi_new[j] &lt;-<span class="st"> </span>(discri <span class="op">-</span><span class="st"> </span>lambda <span class="op">/</span><span class="st"> </span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span>(n <span class="op">-</span><span class="st"> </span>j <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)
            } <span class="co"># already 0 otherwise</span>
        }
        phi_new &lt;-<span class="st"> </span>phi_new[<span class="op">-</span><span class="dv">1</span>]
        phisums_new &lt;-<span class="st"> </span>phisums_new[<span class="op">-</span><span class="dv">1</span>]
        theta &lt;-<span class="st"> </span><span class="kw">c</span>(theta_1_new, theta_1_new <span class="op">+</span><span class="st"> </span>phisums_new)
        cost &lt;-<span class="st"> </span><span class="kw">sum</span>((y <span class="op">-</span><span class="st"> </span>theta)<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>lambda <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">abs</span>(phi_new))
        theta_1_new &lt;-<span class="st"> </span>(<span class="kw">sum</span>(y) <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(phisums_new)) <span class="op">/</span><span class="st"> </span>n
        phisums_old &lt;-<span class="st"> </span>phisums_new
        iter &lt;-<span class="st"> </span>iter <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
        costs[iter <span class="op">+</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span>cost
        there_is_a_progress &lt;-<span class="st"> </span><span class="op">!</span>(<span class="kw">abs</span>(costs[iter] <span class="op">-</span><span class="st"> </span>cost) <span class="op">&lt;=</span><span class="st"> </span>eps)
    }
    <span class="kw">list</span>(
        <span class="dt">theta =</span> theta, 
        <span class="dt">phi =</span> phi_new, 
        <span class="dt">lambda =</span> lambda, 
        <span class="dt">iter =</span> iter, 
        <span class="dt">costs =</span> costs <span class="co"># the first cost is calculated at iteration 0</span>
    )
}</code></pre></div>
<p>Step 3 is done by <code>interpolate_1d</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">interpolate_1d &lt;-<span class="st"> </span><span class="cf">function</span>(t, theta_rest, indices_rest, n) {
    <span class="co"># t: a number, or a numeric vector whose minimum is at least 1 and</span>
    <span class="co">#    whose maximum is at most n</span>
    <span class="co"># theta_rest: a numeric vector</span>
    <span class="co"># indices_rest: an integer vector of length length(theta_rest)</span>
    <span class="co"># n: an integer; the length of &quot;full&quot; data</span>
    
    indices &lt;-<span class="st"> </span><span class="kw">sort</span>(indices_rest)
    <span class="cf">if</span> (<span class="kw">max</span>(t) <span class="op">&gt;</span><span class="st"> </span>n <span class="op">||</span><span class="st"> </span><span class="kw">min</span>(t) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>) {
        <span class="kw">stop</span>(<span class="kw">paste0</span>(
            <span class="st">&#39;</span><span class="ch">\n</span><span class="st">Error in interpolate_1d():</span><span class="ch">\n</span><span class="st">&#39;</span>, 
            <span class="st">&#39;Extrapolation not available;</span><span class="ch">\n</span><span class="st">&#39;</span>,
            <span class="st">&#39;either max(t) &gt; length of full data or min(t) &lt; 1 happened&#39;</span>
        ))
    }
    <span class="cf">if</span> (<span class="kw">length</span>(theta_rest) <span class="op">!=</span><span class="st"> </span><span class="kw">length</span>(indices)) {
        <span class="kw">stop</span>(<span class="kw">paste0</span>(
            <span class="st">&#39;</span><span class="ch">\n</span><span class="st">Error in interpolate_1d():</span><span class="ch">\n</span><span class="st">&#39;</span>, 
            <span class="st">&#39;length(theta_rest) != length(indices)&#39;</span>
        ))
    }
    <span class="kw">sapply</span>(t, <span class="cf">function</span>(d){theta_rest[<span class="kw">which.min</span>(<span class="kw">abs</span>(d <span class="op">-</span><span class="st"> </span>indices))]})
}</code></pre></div>
<p><span class="math inline">\(\text{loss}_s\)</span> in step 4 is computed with <code>loss_1d_fold</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">loss_1d_fold &lt;-<span class="st"> </span><span class="cf">function</span>(y, theta, indices_fold) {
    <span class="co"># y: a numeric vector of length n</span>
    <span class="co"># theta: a numeric vector of length &lt; n</span>
    <span class="co"># indices_fold: an integer vector of length n - length(theta)</span>
    
    n &lt;-<span class="st"> </span><span class="kw">length</span>(y)
    indices_fold &lt;-<span class="st"> </span><span class="kw">sort</span>(indices_fold)
    y_fold &lt;-<span class="st"> </span>y[indices_fold]
    indices_rest &lt;-<span class="st"> </span>(<span class="dv">1</span><span class="op">:</span>n)[<span class="op">!</span>(<span class="dv">1</span><span class="op">:</span>n <span class="op">%in%</span><span class="st"> </span>indices_fold)]
    interpolate &lt;-<span class="st"> </span><span class="kw">interpolate_1d</span>(indices_fold, theta, indices_rest, n)
    <span class="kw">mean</span>((interpolate <span class="op">-</span><span class="st"> </span>y_fold)<span class="op">^</span><span class="dv">2</span>)
}</code></pre></div>
<p>and for the sake of computing training error, we define <code>loss_1d</code> as well:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">loss_1d &lt;-<span class="st"> </span><span class="cf">function</span>(y, theta) {
    <span class="co"># y: the same as in loss_1d_fold</span>
    <span class="co"># theta: a numeric vector of length n</span>
    
    <span class="kw">mean</span>((y <span class="op">-</span><span class="st"> </span>theta)<span class="op">^</span><span class="dv">2</span>)
}</code></pre></div>
<p>We shall now compute the cross-validation error in <code>cv_error_1d</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cv_error_1d &lt;-<span class="st"> </span><span class="cf">function</span>(y, k, lambda) {
    <span class="co"># y: a numeric vector</span>
    <span class="co"># k: an integer; a number of folds</span>
    <span class="co"># lambda: a positive real number</span>
    
    losses &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="dt">length =</span> k)
    <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>k) {
        split_s &lt;-<span class="st"> </span><span class="kw">split_data_1d</span>(y, k, s)
        fusion_s &lt;-<span class="st"> </span><span class="kw">fusion_estimates</span>(split_s<span class="op">$</span>y_rest<span class="op">$</span>data, <span class="dt">lambda =</span> lambda)
        losses[s] &lt;-<span class="st"> </span><span class="kw">loss_1d_fold</span>(y, fusion_s<span class="op">$</span>theta, split_s<span class="op">$</span>y_fold<span class="op">$</span>indices)
    }
    <span class="kw">list</span>(<span class="dt">error =</span> <span class="kw">mean</span>(losses), <span class="dt">losses =</span> losses)
}</code></pre></div>
</div>
<div id="an-example" class="section level1">
<h1>3. An example</h1>
<p>The example in the previous note is regenerated:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1024</span>)
n &lt;-<span class="st"> </span><span class="dv">1000</span>
t &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>n
f &lt;-<span class="st"> </span><span class="cf">function</span>(t) {t <span class="op">/</span><span class="st"> </span><span class="dv">250</span> <span class="op">-</span><span class="st"> </span>.<span class="dv">5</span>}
g &lt;-<span class="st"> </span><span class="cf">function</span>(t) {<span class="op">-</span>(.<span class="dv">25</span> <span class="op">/</span><span class="st"> </span><span class="dv">449</span>) <span class="op">*</span><span class="st"> </span>t <span class="op">+</span><span class="st"> </span><span class="dv">250</span> <span class="op">/</span><span class="st"> </span><span class="dv">449</span>}
true_theta &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">249</span>), <span class="kw">f</span>(<span class="dv">250</span><span class="op">:</span><span class="dv">500</span>), <span class="kw">rep</span>(.<span class="dv">75</span>, <span class="dv">50</span>), <span class="kw">g</span>(<span class="dv">551</span><span class="op">:</span><span class="dv">1000</span>))
y &lt;-<span class="st"> </span>true_theta <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1000</span>, <span class="dv">0</span>, <span class="fl">0.1</span>)
<span class="kw">qplot</span>(t, y)</code></pre></div>
<p><img src="cross_validation_fs_files/figure-html/regenerate-1.png" style="display: block; margin: auto;" /></p>
<p>The following <code>lambda</code> values will be considered. Also, say <span class="math inline">\(k = 5\)</span>, an another arbitrary choice:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lambdas &lt;-<span class="st"> </span><span class="kw">seq</span>(.<span class="dv">1</span>, <span class="dv">5</span>, <span class="dt">by =</span> .<span class="dv">1</span>)
k &lt;-<span class="st"> </span><span class="dv">5</span></code></pre></div>
<p>For each <code>lambda</code>, let’s compute the training error and the cross-validation error:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">start &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
errors &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">sapply</span>(
    lambdas,
    <span class="cf">function</span>(l) {
        <span class="kw">c</span>(
            <span class="kw">cv_error_1d</span>(y, k, l)<span class="op">$</span>error,
            <span class="kw">loss_1d</span>(y, <span class="kw">fusion_estimates</span>(y, <span class="dt">lambda =</span> l)<span class="op">$</span>theta)
        )
    }
)) <span class="op">%&gt;%</span>
<span class="st">    &#39;colnames&lt;-&#39;</span>(<span class="kw">c</span>(<span class="kw">paste0</span>(<span class="st">&#39;C-V error, &#39;</span>, k, <span class="st">&#39; folds&#39;</span>), <span class="st">&#39;Training&#39;</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">cbind</span>(<span class="dt">lambdas =</span> lambdas) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">as_tibble</span>()
end &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</code></pre></div>
<p>This process takes a while. Here’s the link to the <code>errors</code> <a href="../../files/cv_errors.csv">csv file</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">end <span class="op">-</span><span class="st"> </span>start</code></pre></div>
<pre><code>## Time difference of 34.66667 mins</code></pre>
<p>The visualization is as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">errors <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">gather</span>(Errors, value, <span class="op">-</span>lambdas) <span class="op">%&gt;%</span>
<span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lambdas, <span class="dt">y =</span> value, <span class="dt">col =</span> Errors)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">shape =</span> Errors)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&#39;Lambda&#39;</span>, <span class="dt">y =</span> <span class="st">&#39;Average squared error&#39;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&#39;top&#39;</span>)</code></pre></div>
<p><img src="cross_validation_fs_files/figure-html/visualize_errors-1.png" style="display: block; margin: auto;" /></p>
<p>The training error increases as lambda increases. This makes sense since, as shown in the <a href="../2018/non_separable_penalty.html">previous note</a>, <span class="math inline">\(\theta_t \to \overline{y}\)</span> for all <span class="math inline">\(t\)</span> as <span class="math inline">\(\lambda\)</span> gets greater, and <span class="math inline">\(\theta_t = \overline{y}\)</span> for all <span class="math inline">\(t\)</span> starting from a certain value of <span class="math inline">\(\lambda\)</span>. That is, as lambda increases, the fusion estimates start to move away from the least squares estimates <span class="math inline">\(\hat{\theta}_t\)</span>’s (<span class="math inline">\(= y_t\)</span> for all <span class="math inline">\(t\)</span>), which are estimates when <span class="math inline">\(\lambda = 0\)</span> and are values that minimize the average squared error, so the training error increases as shown in the plot.</p>
<p>The minimum lambda that yields the lowest cv-error is therefore:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">errors <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">gather</span>(Errors, value, <span class="op">-</span>lambdas) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(Errors <span class="op">!=</span><span class="st"> &#39;Training&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(value <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(value)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">pull</span>(lambdas)</code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>The proposed value of <span class="math inline">\(\lambda\)</span> is 1.</p>
</div>
<div id="session-info" class="section level1">
<h1>Session info</h1>
<p>R session info:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()</code></pre></div>
<pre><code>## R version 3.6.0 (2019-04-26)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows &gt;= 8 x64 (build 9200)
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=English_Canada.1252  LC_CTYPE=English_Canada.1252   
## [3] LC_MONETARY=English_Canada.1252 LC_NUMERIC=C                   
## [5] LC_TIME=English_Canada.1252    
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] ggConvexHull_0.1.0 ggplot2_3.1.1      dplyr_0.8.1       
## [4] reticulate_1.12    rmarkdown_1.13     magrittr_1.5      
## [7] itertools2_0.1.1  
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.1       plyr_1.8.4       compiler_3.6.0   pillar_1.4.1    
##  [5] prettydoc_0.2.1  iterators_1.0.10 tools_3.6.0      zeallot_0.1.0   
##  [9] digest_0.6.19    jsonlite_1.6     evaluate_0.14    tibble_2.1.3    
## [13] gtable_0.3.0     lattice_0.20-38  png_0.1-7        pkgconfig_2.0.2 
## [17] rlang_0.3.4      Matrix_1.2-17    cli_1.1.0        rstudioapi_0.10 
## [21] yaml_2.2.0       xfun_0.7         withr_2.1.2      stringr_1.4.0   
## [25] xml2_1.2.0       knitr_1.23       vctrs_0.1.0      hms_0.4.2       
## [29] grid_3.6.0       tidyselect_0.2.5 glue_1.3.1       R6_2.4.0        
## [33] fansi_0.4.0      readr_1.3.1      tidyr_0.8.3      purrr_0.3.2     
## [37] backports_1.1.4  scales_1.0.0     htmltools_0.3.6  assertthat_0.2.1
## [41] colorspace_1.4-1 labeling_0.3     utf8_1.1.4       stringi_1.4.3   
## [45] lazyeval_0.2.2   munsell_0.5.0    crayon_1.3.4</code></pre>
</div>
<div id="related-page" class="section level1">
<h1>Related page</h1>
<ul>
<li><a href="../2018/non_separable_penalty.html">Dealing with a non-separable penalty term</a></li>
</ul>
</div>
</section>

<!-- Footer -->
<!-- Reference: https://holtzy.github.io/Pimp-my-rmd/ -->
&nbsp; <!-- whitespace -->
<hr /> <!-- line -->
<div class="footer">
    <p style="text-align: center;">
        <a href="../../index.html" style="font-size: 11pt;">Home</a> · <a href="../../projects.html" style="font-size: 11pt;">Projects</a> · <a href="../../research_materials.html" style="font-size: 11pt;">Research materials</a> · <a href="../../news.html" style="font-size: 11pt;">News</a> · <a href="../../files/resume_junkyu_park.pdf" style="font-size: 11pt;">Resume</a>
    </p>
    <p style="text-align: center;">
        © 2019 Junkyu Park<br>Powered by the <a href="https://github.com/yixuan/prettydoc">prettydoc::html_pretty</a> engine<br>Current theme: modified <a href="https://github.com/jasonlong/cayman-theme">Cayman</a>
    </p>
            
    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
            
    <!-- Add font awesome icons -->
    <p style="text-align: center;">
        <span style="color: #555555;"><em>joon3216@gmail.com</em></span>
        <br>
        <a href="https://www.facebook.com/asdfzxcvjkl1" class="fa fa-facebook"></a>
        <a href="https://github.com/joon3216" class="fa fa-github"></a>
        <a href="https://linkedin.com/in/asdfzxcvjkl1/" class="fa fa-linkedin"></a>
        <a href="https://twitter.com/joon3216" class="fa fa-twitter"></a>
    </p>
</div>
&nbsp; <!-- whitespace -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
